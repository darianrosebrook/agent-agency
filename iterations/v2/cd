[0m[7m[1m[31m FAIL [39m[22m[27m[0m [2mtests/unit/evaluation/[22m[1mModelRegistryLLMProvider.test.ts[22m ([0m[1m[41m65.336 s[49m[22m[0m)
[0m[7m[1m[31m FAIL [39m[22m[27m[0m [2mtests/unit/evaluation/[22m[1mModelRegistryLLMProvider.test.ts[22m ([0m[1m[41m65.336 s[49m[22m[0m)
  [1m‚óè [22mConsole

    [2mconsole.log[22m
      [ConnectionPool] Initialized: localhost:5432/agent_agency_v2_test (min: 2, max: 10)
[2m[22m
[2m      [2mat ConnectionPoolManager.initialize ([22m[2msrc/database/ConnectionPoolManager.ts[2m:162:13)[22m[2m[22m

    [2mconsole.log[22m
      [ConnectionPool] New connection established (total: 1)
[2m[22m
[2m      [2mat BoundPool.<anonymous> ([22m[2msrc/database/ConnectionPoolManager.ts[2m:138:15)[22m[2m[22m

    [2mconsole.log[22m
      [ConnectionPool] Connection acquired (active: 1, idle: 0)
[2m[22m
[2m      [2mat BoundPool.<anonymous> ([22m[2msrc/database/ConnectionPoolManager.ts[2m:144:15)[22m[2m[22m

    [2mconsole.log[22m
      Database pool initialized for tests (1 connections, status: healthy)
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2mtests/setup.ts[2m:45:17)[22m[2m[22m

    [2mconsole.log[22m
      [ConnectionPool] Shutting down...
[2m[22m
[2m      [2mat ConnectionPoolManager.shutdown ([22m[2msrc/database/ConnectionPoolManager.ts[2m:351:13)[22m[2m[22m

    [2mconsole.log[22m
      [ConnectionPool] All connections closed
[2m[22m
[2m      [2mat ConnectionPoolManager.shutdown ([22m[2msrc/database/ConnectionPoolManager.ts[2m:355:15)[22m[2m[22m

    [2mconsole.log[22m
      Database pool closed after tests
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2mtests/setup.ts[2m:69:15)[22m[2m[22m

  [1m‚óè [22mConsole

    [2mconsole.log[22m
      [ConnectionPool] Initialized: localhost:5432/agent_agency_v2_test (min: 2, max: 10)
[2m[22m
[2m      [2mat ConnectionPoolManager.initialize ([22m[2msrc/database/ConnectionPoolManager.ts[2m:162:13)[22m[2m[22m

    [2mconsole.log[22m
      [ConnectionPool] New connection established (total: 1)
[2m[22m
[2m      [2mat BoundPool.<anonymous> ([22m[2msrc/database/ConnectionPoolManager.ts[2m:138:15)[22m[2m[22m

    [2mconsole.log[22m
      [ConnectionPool] Connection acquired (active: 1, idle: 0)
[2m[22m
[2m      [2mat BoundPool.<anonymous> ([22m[2msrc/database/ConnectionPoolManager.ts[2m:144:15)[22m[2m[22m

    [2mconsole.log[22m
      Database pool initialized for tests (1 connections, status: healthy)
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2mtests/setup.ts[2m:45:17)[22m[2m[22m

    [2mconsole.log[22m
      [ConnectionPool] Shutting down...
[2m[22m
[2m      [2mat ConnectionPoolManager.shutdown ([22m[2msrc/database/ConnectionPoolManager.ts[2m:351:13)[22m[2m[22m

    [2mconsole.log[22m
      [ConnectionPool] All connections closed
[2m[22m
[2m      [2mat ConnectionPoolManager.shutdown ([22m[2msrc/database/ConnectionPoolManager.ts[2m:355:15)[22m[2m[22m

    [2mconsole.log[22m
      Database pool closed after tests
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2mtests/setup.ts[2m:69:15)[22m[2m[22m

[1m[31m  [1m‚óè [22m[1mModelRegistryLLMProvider ‚Ä∫ Criterion-Specific Evaluation ‚Ä∫ should evaluate relevance based on output length[39m[22m

    [2mexpect([22m[31mreceived[39m[2m).[22mtoBeGreaterThan[2m([22m[32mexpected[39m[2m)[22m

    Expected: > [32m1[39m
    Received:   [31m0.95[39m
[2m[22m
[2m    [0m [90m 208 |[39m       )[33m;[39m[22m
[2m     [90m 209 |[39m[22m
[2m    [31m[1m>[22m[2m[39m[90m 210 |[39m       expect(longResult[33m.[39mscore)[33m.[39mtoBeGreaterThan(shortResult[33m.[39mscore)[33m;[39m[22m
[2m     [90m     |[39m                                [31m[1m^[22m[2m[39m[22m
[2m     [90m 211 |[39m     })[33m;[39m[22m
[2m     [90m 212 |[39m[22m
[2m     [90m 213 |[39m     it([32m"should evaluate minimality based on output length"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m[22m
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2m[0m[36mtests/unit/evaluation/ModelRegistryLLMProvider.test.ts[39m[0m[2m:210:32)[22m[2m[22m

[1m[31m  [1m‚óè [22m[1mModelRegistryLLMProvider ‚Ä∫ Criterion-Specific Evaluation ‚Ä∫ should evaluate safety by detecting unsafe patterns[39m[22m

    [2mexpect([22m[31mreceived[39m[2m).[22mtoBeGreaterThan[2m([22m[32mexpected[39m[2m)[22m

    Expected: > [32m1[39m
    Received:   [31m1[39m
[2m[22m
[2m    [0m [90m 254 |[39m       )[33m;[39m[22m
[2m     [90m 255 |[39m[22m
[2m    [31m[1m>[22m[2m[39m[90m 256 |[39m       expect(safeResult[33m.[39mscore)[33m.[39mtoBeGreaterThan(unsafeResult[33m.[39mscore)[33m;[39m[22m
[2m     [90m     |[39m                                [31m[1m^[22m[2m[39m[22m
[2m     [90m 257 |[39m       expect(unsafeResult[33m.[39mscore)[33m.[39mtoBeLessThan([35m0.5[39m)[33m;[39m [90m// Should be flagged as unsafe[39m[22m
[2m     [90m 258 |[39m     })[33m;[39m[22m
[2m     [90m 259 |[39m   })[33m;[39m[0m[22m
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2m[0m[36mtests/unit/evaluation/ModelRegistryLLMProvider.test.ts[39m[0m[2m:256:32)[22m[2m[22m

[1m[31m  [1m‚óè [22m[1mModelRegistryLLMProvider ‚Ä∫ Model Selection ‚Ä∫ should respect latency constraints[39m[22m

    [2mexpect([22m[31mreceived[39m[2m).[22mtoBe[2m([22m[32mexpected[39m[2m) // Object.is equality[22m

    Expected: [32m"test-model-[7m2[27m-1.0.0-1760395763521"[39m
    Received: [31m"test-model-[7m1[27m-1.0.0-1760395763521"[39m
[2m[22m
[2m    [0m [90m 352 |[39m[22m
[2m     [90m 353 |[39m       [90m// Should select the fast model[39m[22m
[2m    [31m[1m>[22m[2m[39m[90m 354 |[39m       expect(fastProvider[33m.[39mgetActiveModelId())[33m.[39mtoBe(models[[35m1[39m][33m.[39mid)[33m;[39m[22m
[2m     [90m     |[39m                                               [31m[1m^[22m[2m[39m[22m
[2m     [90m 355 |[39m     })[33m;[39m[22m
[2m     [90m 356 |[39m[22m
[2m     [90m 357 |[39m     it([32m"should update active model on each evaluation"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m[22m
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2m[0m[36mtests/unit/evaluation/ModelRegistryLLMProvider.test.ts[39m[0m[2m:354:47)[22m[2m[22m

[1m[31m  [1m‚óè [22m[1mModelRegistryLLMProvider ‚Ä∫ Edge Cases ‚Ä∫ should handle special characters in output[39m[22m

    [2mexpect([22m[31mreceived[39m[2m).[22mtoBeGreaterThan[2m([22m[32mexpected[39m[2m)[22m

    Expected: > [32m0.5[39m
    Received:   [31m0.5[39m
[2m[22m
[2m    [0m [90m 499 |[39m[22m
[2m     [90m 500 |[39m       expect(result)[33m.[39mtoBeDefined()[33m;[39m[22m
[2m    [31m[1m>[22m[2m[39m[90m 501 |[39m       expect(result[33m.[39mscore)[33m.[39mtoBeGreaterThan([35m0.5[39m)[33m;[39m [90m// Should be safe[39m[22m
[2m     [90m     |[39m                            [31m[1m^[22m[2m[39m[22m
[2m     [90m 502 |[39m     })[33m;[39m[22m
[2m     [90m 503 |[39m[22m
[2m     [90m 504 |[39m     it([32m"should handle multiple uns[1m[31m  [1m‚óè [22m[1mModelRegistryLLMProvider ‚Ä∫ Criterion-Specific Evaluation ‚Ä∫ should evaluate relevance based on output length[39m[22m

    [2mexpect([22m[31mreceived[39m[2m).[22mtoBeGreaterThan[2m([22m[32mexpected[39m[2m)[22m

    Expected: > [32m1[39m
    Received:   [31m0.95[39m
[2m[22m
[2m    [0m [90m 208 |[39m       )[33m;[39m[22m
[2m     [90m 209 |[39m[22m
[2m    [31m[1m>[22m[2m[39m[90m 210 |[39m       expect(longResult[33m.[39mscore)[33m.[39mtoBeGreaterThan(shortResult[33m.[39mscore)[33m;[39m[22m
[2m     [90m     |[39m                                [31m[1m^[22m[2m[39m[22m
[2m     [90m 211 |[39m     })[33m;[39m[22m
[2m     [90m 212 |[39m[22m
[2m     [90m 213 |[39m     it([32m"should evaluate minimality based on output length"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m[22m
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2m[0m[36mtests/unit/evaluation/ModelRegistryLLMProvider.test.ts[39m[0m[2m:210:32)[22m[2m[22m

[1m[31m  [1m‚óè [22m[1mModelRegistryLLMProvider ‚Ä∫ Criterion-Specific Evaluation ‚Ä∫ should evaluate safety by detecting unsafe patterns[39m[22m

    [2mexpect([22m[31mreceived[39m[2m).[22mtoBeGreaterThan[2m([22m[32mexpected[39m[2m)[22m

    Expected: > [32m1[39m
    Received:   [31m1[39m
[2m[22m
[2m    [0m [90m 254 |[39m       )[33m;[39m[22m
[2m     [90m 255 |[39m[22m
[2m    [31m[1m>[22m[2m[39m[90m 256 |[39m       expect(safeResult[33m.[39mscore)[33m.[39mtoBeGreaterThan(unsafeResult[33m.[39mscore)[33m;[39m[22m
[2m     [90m     |[39m                                [31m[1m^[22m[2m[39m[22m
[2m     [90m 257 |[39m       expect(unsafeResult[33m.[39mscore)[33m.[39mtoBeLessThan([35m0.5[39m)[33m;[39m [90m// Should be flagged as unsafe[39m[22m
[2m     [90m 258 |[39m     })[33m;[39m[22m
[2m     [90m 259 |[39m   })[33m;[39m[0m[22m
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2m[0m[36mtests/unit/evaluation/ModelRegistryLLMProvider.test.ts[39m[0m[2m:256:32)[22m[2m[22m

[1m[31m  [1m‚óè [22m[1mModelRegistryLLMProvider ‚Ä∫ Model Selection ‚Ä∫ should respect latency constraints[39m[22m

    [2mexpect([22m[31mreceived[39m[2m).[22mtoBe[2m([22m[32mexpected[39m[2m) // Object.is equality[22m

    Expected: [32m"test-model-[7m2[27m-1.0.0-1760395763521"[39m
    Received: [31m"test-model-[7m1[27m-1.0.0-1760395763521"[39m
[2m[22m
[2m    [0m [90m 352 |[39m[22m
[2m     [90m 353 |[39m       [90m// Should select the fast model[39m[22m
[2m    [31m[1m>[22m[2m[39m[90m 354 |[39m       expect(fastProvider[33m.[39mgetActiveModelId())[33m.[39mtoBe(models[[35m1[39m][33m.[39mid)[33m;[39m[22m
[2m     [90m     |[39m                                               [31m[1m^[22m[2m[39m[22m
[2m     [90m 355 |[39m     })[33m;[39m[22m
[2m     [90m 356 |[39m[22m
[2m     [90m 357 |[39m     it([32m"should update active model on each evaluation"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m[22m
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2m[0m[36mtests/unit/evaluation/ModelRegistryLLMProvider.test.ts[39m[0m[2m:354:47)[22m[2m[22m

[1m[31m  [1m‚óè [22m[1mModelRegistryLLMProvider ‚Ä∫ Edge Cases ‚Ä∫ should handle special characters in output[39m[22m

    [2mexpect([22m[31mreceived[39m[2m).[22mtoBeGreaterThan[2m([22m[32mexpected[39m[2m)[22m

    Expected: > [32m0.5[39m
    Received:   [31m0.5[39m
[2m[22m
[2m    [0m [90m 499 |[39m[22m
[2m     [90m 500 |[39m       expect(result)[33m.[39mtoBeDefined()[33m;[39m[22m
[2m    [31m[1m>[22m[2m[39m[90m 501 |[39m       expect(result[33m.[39mscore)[33m.[39mtoBeGreaterThan([35m0.5[39m)[33m;[39m [90m// Should be safe[39m[22m
[2m     [90m     |[39m                            [31m[1m^[22m[2m[39m[22m
[2m     [90m 502 |[39m     })[33m;[39m[22m
[2m     [90m 503 |[39m[22m
[2m     [90m 504 |[39m     it([32m"should handle multiple unsafe patterns"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m[22m
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2m[0m[36mtests/unit/evaluation/ModelRegistryLLMProvider.test.ts[39m[0m[2m:501:28)[22m[2m[22m

[1m[31m  [1m‚óè [22m[1mModelRegistryLLMProvider ‚Ä∫ Edge Cases ‚Ä∫ should handle multiple unsafe patterns[39m[22m

    [2mexpect([22m[31mreceived[39m[2m).[22mtoBeLessThan[2m([22m[32mexpected[39m[2m)[22m

    Expected: < [32m0.5[39m
    Received:   [31m1[39m
[2m[22m
[2m    [0m [90m 511 |[39m[22m
[2m     [90m 512 |[39m       expect(result)[33m.[39mtoBeDefined()[33m;[39m[22m
[2m    [31m[1m>[22m[2m[39m[90m 513 |[39m       expect(result[33m.[39mscore)[33m.[39mtoBeLessThan([35m0.5[39m)[33m;[39m [90m// Should be flagged[39m[22m
[2m     [90m     |[39m                            [31m[1m^[22m[2m[39m[22m
[2m     [90m 514 |[39m     })[33m;[39m[22m
[2m     [90m 515 |[39m   })[33m;[39m[22m
[2m     [90m 516 |[39m[0m[22m
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2m[0m[36mtests/unit/evaluation/ModelRegistryLLMProvider.test.ts[39m[0m[2m:513:28)[22m[2m[22m

afe patterns"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m[22m
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2m[0m[36mtests/unit/evaluation/ModelRegistryLLMProvider.test.ts[39m[0m[2m:501:28)[22m[2m[22m

[1m[31m  [1m‚óè [22m[1mModelRegistryLLMProvider ‚Ä∫ Edge Cases ‚Ä∫ should handle multiple unsafe patterns[39m[22m

    [2mexpect([22m[31mreceived[39m[2m).[22mtoBeLessThan[2m([22m[32mexpected[39m[2m)[22m

    Expected: < [32m0.5[39m
    Received:   [31m1[39m
[2m[22m
[2m    [0m [90m 511 |[39m[22m
[2m     [90m 512 |[39m       expect(result)[33m.[39mtoBeDefined()[33m;[39m[22m
[2m    [31m[1m>[22m[2m[39m[90m 513 |[39m       expect(result[33m.[39mscore)[33m.[39mtoBeLessThan([35m0.5[39m)[33m;[39m [90m// Should be flagged[39m[22m
[2m     [90m     |[39m                            [31m[1m^[22m[2m[39m[22m
[2m     [90m 514 |[39m     })[33m;[39m[22m
[2m     [90m 515 |[39m   })[33m;[39m[22m
[2m     [90m 516 |[39m[0m[22m
[2m[22m
[2m      [2mat Object.<anonymous> ([22m[2m[0m[36mtests/unit/evaluation/ModelRegistryLLMProvider.test.ts[39m[0m[2m:513:28)[22m[2m[22m


  [1m‚óè [22m [31m[1mCannot log after tests are done.[22m Did you forget to wait for something async in your test?[39m
    Attempted to log "[ConnectionPool] Connection removed (total: undefined)".

    [0m [90m 150 |[39m
     [90m 151 |[39m     [36mthis[39m[33m.[39mpool[33m.[39mon([32m"remove"[39m[33m,[39m (_client) [33m=>[39m {
    [31m[1m>[22m[39m[90m 152 |[39m       console[33m.[39mlog(
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 153 |[39m         [32m`[ConnectionPool] Connection removed (total: ${this.pool?.totalCount})`[39m
     [90m 154 |[39m       )[33m;[39m
     [90m 155 |[39m     })[33m;[39m[0m

      [2mat console.log ([22m../../node_modules/@jest/console/build/BufferedConsole.js[2m:156:10)[22m
      [2mat BoundPool.<anonymous> ([22msrc/database/ConnectionPoolManager.ts[2m:152:15)[22m
      [2mat Connection.<anonymous> ([22m../../node_modules/pg-pool/index.js[2m:174:15)[22m
      [2mat Socket.<anonymous> ([22m../../node_modules/pg/lib/connection.js[2m:62:12)[22m


  [1m‚óè [22m [31m[1mCannot log after tests are done.[22m Did you forget to wait for something async in your test?[39m
    Attempted to log "[ConnectionPool] Connection removed (total: undefined)".

    [0m [90m 150 |[39m
     [90m 151 |[39m     [36mthis[39m[33m.[39mpool[33m.[39mon([32m"remove"[39m[33m,[39m (_client) [33m=>[39m {
    [31m[1m>[22m[39m[90m 152 |[39m       console[33m.[39mlog(
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 153 |[39m         [32m`[ConnectionPool] Connection removed (total: ${this.pool?.totalCount})`[39m
     [90m 154 |[39m       )[33m;[39m
     [90m 155 |[39m     })[33m;[39m[0m

      [2mat console.log ([22m../../node_modules/@jest/console/build/BufferedConsole.js[2m:156:10)[22m
      [2mat BoundPool.<anonymous> ([22msrc/database/ConnectionPoolManager.ts[2m:152:15)[22m
      [2mat Connection.<anonymous> ([22m../../node_modules/pg-pool/index.js[2m:174:15)[22m
      [2mat Socket.<anonymous> ([22m../../node_modules/pg/lib/connection.js[2m:62:12)[22m

