id: ARBITER-005-REFACTOR
title: "Consolidate Three Orchestrator Implementations into Canonical ArbiterOrchestrator"
risk_tier: 1
mode: refactor
change_budget:
  max_files: 30
  max_loc: 1500
blast_radius:
  modules: ["orchestrator", "rl", "mcp-server"]
  data_migration: false
operational_rollback_slo: "5m"

scope:
  in:
    - "src/orchestrator/ArbiterOrchestrator.ts"
    - "src/orchestrator/EnhancedArbiterOrchestrator.ts"
    - "src/orchestrator/TaskOrchestrator.ts"
    - "src/orchestrator/utils/"
    - "src/orchestrator/capabilities/"
    - "tests/unit/orchestrator/"
    - "src/mcp-server/ArbiterMCPServer.ts"
    - "src/mcp-server/handlers/knowledge-tools.ts"
  out:
    - "node_modules/"
    - "dist/"
    - "coverage/"
    - "src/rl/"
    - "src/health/"
    - "src/observability/"

invariants:
  - "All public APIs maintain backward compatibility"
  - "No behavior changes - only structural refactoring"
  - "Tests must pass before and after refactoring"
  - "No 'enhanced' or 'new' file naming patterns introduced"
  - "Existing integrations with MCP server remain functional"

acceptance:
  - id: "A1"
    given: "Three separate orchestrator implementations exist"
    when: "Refactoring is complete"
    then: "Single canonical ArbiterOrchestrator with all capabilities exists"
  
  - id: "A2"
    given: "EnhancedArbiterOrchestrator adds RL capabilities"
    when: "RL features are extracted to utils"
    then: "RLCapability utility integrates with ArbiterOrchestrator via composition"
  
  - id: "A3"
    given: "TaskOrchestrator has event-based lifecycle management"
    when: "Lifecycle features are extracted"
    then: "TaskLifecycleManager utility integrates with ArbiterOrchestrator"
  
  - id: "A4"
    given: "Multiple test files exist for each orchestrator"
    when: "Orchestrators are consolidated"
    then: "Single comprehensive test suite covers all functionality"
  
  - id: "A5"
    given: "MCP server and handlers use ArbiterOrchestrator"
    when: "Refactoring is complete"
    then: "All imports updated and functionality preserved"
  
  - id: "A6"
    given: "EnhancedArbiterOrchestrator and TaskOrchestrator files exist"
    when: "Consolidation is complete"
    then: "Both files are deleted and removed from version control"

non_functional:
  maintainability: ["No duplicate/fork file patterns", "Clear separation of concerns", "Utility composition over inheritance"]
  testability: ["≥90% branch coverage (Tier 1)", "≥70% mutation score (Tier 1)"]
  performance:
    orchestration_p95_ms: 50
    memory_overhead_mb: 5

contracts:
  - type: "typescript"
    description: "ArbiterOrchestrator public API must not change"
    validation: "TypeScript compilation must succeed"
  
  - type: "test"
    description: "All existing tests must pass"
    validation: "npm test must succeed"

migration_plan:
  steps:
    - description: "Extract RL capabilities to src/orchestrator/capabilities/RLCapability.ts"
      risk: "low"
      rollback: "Revert file creation"
    
    - description: "Extract event-based lifecycle to src/orchestrator/utils/TaskLifecycleManager.ts"
      risk: "low"
      rollback: "Revert file creation"
    
    - description: "Extract statistics collection to src/orchestrator/utils/StatisticsCollector.ts"
      risk: "low"
      rollback: "Revert file creation"
    
    - description: "Integrate utilities into ArbiterOrchestrator via composition"
      risk: "medium"
      rollback: "Revert ArbiterOrchestrator.ts to previous version"
    
    - description: "Update all imports from Enhanced/TaskOrchestrator to ArbiterOrchestrator"
      risk: "medium"
      rollback: "Revert import changes"
    
    - description: "Consolidate test files into comprehensive suite"
      risk: "low"
      rollback: "Restore original test files"
    
    - description: "Delete EnhancedArbiterOrchestrator.ts and TaskOrchestrator.ts"
      risk: "low"
      rollback: "Restore from git"

  verification:
    - "npm run typecheck passes"
    - "npm test passes (all tests)"
    - "npm run lint passes"
    - "MCP server integration tests pass"
    - "No references to deleted files remain"

provenance:
  author: "@darianrosebrook"
  created: "2025-10-13"
  ticket: "ARBITER-005"
  rationale: "Eliminate forbidden 'enhanced' naming pattern and consolidate duplicate orchestration logic into canonical implementation with proper utility composition"
