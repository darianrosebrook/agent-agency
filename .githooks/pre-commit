#!/bin/bash

# CAWS Pre-commit Hook - Hidden TODO Analyzer
# @author @darianrosebrook

echo "üîç CAWS Pre-commit Hook: Checking for hidden TODOs..."

# Get staged files that are being committed
STAGED_FILES=$(git diff --cached --name-only | tr '\n' ' ')

if [ -z "$STAGED_FILES" ]; then
    echo "‚ÑπÔ∏è  No files staged for commit"
    exit 0
fi

echo "üìÅ Files to check: $STAGED_FILES"

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo "‚ö†Ô∏è  Python3 not found - skipping hidden TODO check"
    exit 0
fi

# Check if the analyzer script exists
if [ ! -f "iterations/v3/scripts/todo_analyzer.py" ]; then
    echo "‚ö†Ô∏è  TODO analyzer script not found - skipping check"
    exit 0
fi

# Run the analyzer in warn-only mode
echo "üîç Running hidden TODO analysis..."
cd iterations/v3
python3 scripts/todo_analyzer.py --files $STAGED_FILES --warn-only --verbose

# Get the exit code
EXIT_CODE=$?

if [ $EXIT_CODE -eq 0 ]; then
    echo "‚úÖ Pre-commit check passed - no hidden TODOs found"
else
    echo ""
    echo "‚ö†Ô∏è  HIDDEN TODOs DETECTED IN STAGED FILES"
    echo "   The commit will proceed, but please consider addressing these TODOs"
    echo "   You can bypass this check with: git commit --no-verify"
    echo "   Or skip the TODO check entirely with [skip-todo-check] in commit message"
fi

exit 0
