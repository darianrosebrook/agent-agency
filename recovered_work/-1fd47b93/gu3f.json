{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://agent-agency/v3/contracts/quality-report.schema.json",
  "$defs": {
    "GateResult": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "gate_name": {"type": "string"},
        "gate_type": {
          "type": "string",
          "enum": ["lint", "type_check", "unit_test", "integration_test", "e2e_test", "coverage", "mutation", "security", "performance", "accessibility"]
        },
        "status": {
          "type": "string",
          "enum": ["passed", "failed", "warning", "skipped", "error", "timeout"]
        },
        "score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Quality score for this gate (0.0-1.0)"
        },
        "threshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Required threshold for passing"
        },
        "duration_ms": {"type": "integer", "minimum": 0},
        "issues": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "severity": {
                "type": "string",
                "enum": ["error", "warning", "info"]
              },
              "code": {"type": "string"},
              "message": {"type": "string"},
              "file": {"type": "string"},
              "line": {"type": "integer"},
              "column": {"type": "integer"},
              "suggestion": {"type": "string"}
            },
            "required": ["severity", "message"]
          }
        },
        "metrics": {
          "type": "object",
          "additionalProperties": true,
          "description": "Gate-specific metrics and measurements"
        },
        "executed_at": {"type": "string", "format": "date-time"},
        "command_used": {"type": "string"}
      },
      "required": ["gate_name", "gate_type", "status", "score", "threshold", "executed_at"]
    }
  },
  "title": "QualityReport",
  "description": "Comprehensive quality assessment with gate results and thresholds",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Contract version for compatibility"
    },
    "task_id": {
      "type": "string",
      "format": "uuid",
      "description": "Task identifier"
    },
    "working_spec_id": {
      "type": "string",
      "pattern": "^[A-Z]+-[0-9]+$",
      "description": "Working spec identifier"
    },
    "iteration": {
      "type": "integer",
      "minimum": 1,
      "description": "Execution iteration number"
    },
    "overall_score": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Weighted overall quality score (0.0-1.0)"
    },
    "overall_status": {
      "type": "string",
      "enum": ["passed", "failed", "warning", "partial"],
      "description": "Overall assessment status"
    },
    "gates": {
      "type": "array",
      "items": {"$ref": "#/$defs/GateResult"},
      "description": "Results from all quality gates"
    },
    "thresholds": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "risk_tier": {
          "type": "integer",
          "minimum": 1,
          "maximum": 3,
          "description": "Risk tier determining threshold stringency"
        },
        "gate_thresholds": {
          "type": "object",
          "patternProperties": {
            "^.*$": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Per-gate threshold requirements"
            }
          },
          "description": "Gate-specific threshold requirements"
        },
        "overall_threshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Overall quality score threshold"
        },
        "blocking_gates": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Gate names that must pass (no warnings allowed)"
        }
      },
      "required": ["risk_tier", "gate_thresholds", "overall_threshold"],
      "description": "Quality thresholds based on risk tier"
    },
    "deltas": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "from_previous_iteration": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "overall_score_delta": {"type": "number"},
            "gates_improved": {"type": "integer", "minimum": 0},
            "gates_regressed": {"type": "integer", "minimum": 0},
            "gates_newly_passing": {"type": "integer", "minimum": 0},
            "gates_newly_failing": {"type": "integer", "minimum": 0}
          },
          "description": "Changes from previous iteration"
        },
        "from_baseline": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "overall_score_delta": {"type": "number"},
            "gates_improved": {"type": "integer", "minimum": 0},
            "gates_regressed": {"type": "integer", "minimum": 0}
          },
          "description": "Changes from project baseline"
        }
      },
      "description": "Quality score deltas and trends"
    },
    "performance_metrics": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "total_execution_time_ms": {"type": "integer", "minimum": 0},
        "gates_execution_time_ms": {"type": "integer", "minimum": 0},
        "slowest_gate": {"type": "string"},
        "fastest_gate": {"type": "string"},
        "parallelization_efficiency": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "How well gates were parallelized (1.0 = perfect)"
        },
        "resource_usage": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "peak_memory_mb": {"type": "integer", "minimum": 0},
            "cpu_time_ms": {"type": "integer", "minimum": 0},
            "io_operations": {"type": "integer", "minimum": 0}
          }
        }
      },
      "description": "Performance metrics for quality gate execution"
    },
    "recommendations": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "priority": {
            "type": "string",
            "enum": ["critical", "high", "medium", "low"]
          },
          "category": {
            "type": "string",
            "enum": ["testing", "code_quality", "performance", "security", "accessibility", "maintainability"]
          },
          "action": {"type": "string"},
          "rationale": {"type": "string"},
          "estimated_effort": {
            "type": "string",
            "enum": ["trivial", "small", "medium", "large", "unknown"]
          },
          "automated": {"type": "boolean"}
        },
        "required": ["priority", "category", "action", "rationale"]
      },
      "description": "Actionable recommendations for improvement"
    },
    "metadata": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "generated_at": {"type": "string", "format": "date-time"},
        "generator_version": {"type": "string"},
        "environment": {"type": "string"},
        "config_used": {"type": "object", "additionalProperties": true},
        "caching_used": {"type": "boolean"},
        "incremental_run": {"type": "boolean"}
      },
      "required": ["generated_at"],
      "description": "Report generation metadata"
    }
  },
  "required": ["version", "task_id", "working_spec_id", "iteration", "overall_score", "overall_status", "gates", "thresholds"]
}
