id: AGENT-0007
title: "Make diffs first-class artifacts in observability"
risk_tier: 2
mode: feature
change_budget:
  max_files: 6
  max_loc: 400
blast_radius:
  modules: ["observability", "self-prompting-agent"]
  data_migration: false
operational_rollback_slo: "2m"
scope:
  in:
    - "iterations/v3/observability/src/diff_observability.rs"  # New module
    - "iterations/v3/observability/src/lib.rs"  # Add diff_observability module
    - "iterations/v3/self-prompting-agent/src/loop_controller.rs"  # Integrate diff generation
    - "iterations/v3/self-prompting-agent/src/types.rs"  # Add Diff artifact type
  out:
    - "iterations/v3/orchestration/"
    - "iterations/v3/database/"
    - "iterations/v3/interfaces/"
    - "iterations/v3/council/"
invariants:
  - "Every iteration generates unified diff artifacts automatically"
  - "Diff artifacts include allow-list violation highlighting"
  - "Side-by-side diff viewer shows before/after with syntax highlighting"
  - "Diff artifacts are stored with iteration metadata for provenance"
  - "Allow-list violations are toggled and filtered in diff display"
acceptance:
  - id: "A1"
    given: "Task iteration completes with file changes"
    when: "diff observability runs"
    then: "unified diff artifact is generated and stored"
  - id: "A2"
    given: "Changeset includes files outside allow-list"
    when: "diff generation processes violations"
    then: "violations are highlighted with toggle controls"
  - id: "A3"
    given: "Diff viewer is invoked on artifact"
    when: "side-by-side mode is selected"
    then: "shows before/after with syntax highlighting"
  - id: "A4"
    given: "Diff contains multiple file changes"
    when: "allow-list violations are toggled"
    then: "can filter to show only violations or all changes"
  - id: "A5"
    given: "Iteration completes successfully"
    when: "diff artifact generation runs"
    then: "includes iteration metadata and provenance links"
contracts:
  - type: "rust-api"
    path: "iterations/v3/observability/src/diff_observability.rs"
    endpoints:
      - "DiffGenerator::generate_unified_diff()"
      - "DiffViewer::render_side_by_side()"
      - "AllowListChecker::check_violations()"
    schemas:
      - name: "UnifiedDiff"
        fields: ["header: DiffHeader", "hunks: Vec<DiffHunk>", "stats: DiffStats"]
      - name: "DiffHunk"
        fields: ["old_start: u32", "old_lines: u32", "new_start: u32", "new_lines: u32", "lines: Vec<String>", "is_violation: bool"]
      - name: "DiffStats"
        fields: ["files_changed: usize", "insertions: usize", "deletions: usize", "violations: usize"]
non_functional:
  perf:
    diff_generation_ms: 50
    diff_rendering_ms: 25
  security:
    - "no-arbitrary-file-read"
    - "allow-list-enforcement"
  reliability:
    - "diff-integrity-verification"
    - "syntax-highlighting-fallback"