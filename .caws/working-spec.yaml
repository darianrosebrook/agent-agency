id: AGENT-001
title: "P0 Blockers: Truthful System Loop with Auditability and Control"
risk_tier: 1
mode: feature
change_budget:
  max_files: 40
  max_loc: 2500
blast_radius:
  modules: ["orchestration", "api-server", "workers", "interfaces", "dashboard", "context-preservation"]
  data_migration: true
operational_rollback_slo: "10m"
scope:
  in:
    - "iterations/v3/api-server/src/main.rs"
    - "iterations/v3/orchestration/src/audit_trail.rs"
    - "iterations/v3/workers/src/executor.rs"
    - "iterations/v3/interfaces/websocket.rs"
    - "iterations/v3/interfaces/mcp.rs"
    - "iterations/v3/src/bin/api-server.rs"
    - "iterations/v3/cli/src/main.rs"
    - "iterations/v3/apps/web-dashboard/src/components/metrics/MetricsDashboard.tsx"
    - "iterations/v3/apps/web-dashboard/src/lib/api-client.ts"
    - "iterations/v3/apps/web-dashboard/src/components/database/DatabaseExplorer.tsx"
    - "iterations/v3/context-preservation-engine/src/context_manager.rs"
    - "iterations/v3/observability/src/tracing.rs"
    - "iterations/v3/orchestration/src/arbiter.rs"
    - "iterations/v3/orchestration/src/audited_orchestrator.rs"
    - "iterations/v3/database/migrations/"
  out:
    - "iterations/v3/apple-silicon/"
    - "iterations/v3/enrichers/"
    - "iterations/v3/embedding-service/"
    - "iterations/v3/ingestors/"
    - "iterations/v3/reflexive-learning/"
    - "iterations/v3/research/"
    - "iterations/v3/model-benchmarking/"
invariants:
  - "No simulations in production execution path - all components must be real implementations"
  - "All task operations must be auditable with persistent event trails"
  - "System state must survive restarts without data loss"
  - "All secrets must be managed through keystore abstraction, never plaintext"
  - "API endpoints must enforce authentication when required"
  - "Metrics displayed must reflect actual system state, not mock data"
  - "Cancel operations must propagate to workers within 2 seconds"
  - "Worker execution must include circuit breaker and retry logic"
acceptance:
  - id: "A1"
    given: "Task is created and executed"
    when: "GET /tasks/:id is called"
    then: "Response includes non-empty events[] array with persisted audit trail"
  - id: "A2"
    given: "Task execution triggers worker call"
    when: "Worker receives HTTP request"
    then: "Request contains mapped CawsSpec and worker executes real computation"
  - id: "A3"
    given: "API server starts without config"
    when: "Server initialization runs"
    then: "Boot fails with clear error message about missing configuration"
  - id: "A4"
    given: "require_api_key=true and no API key provided"
    when: "Request is made to protected endpoint"
    then: "Request is rejected with 401 Unauthorized"
  - id: "A5"
    given: "Task has progress events and websocket reconnects with include_history=true"
    when: "Client receives replay"
    then: "Last N historical events are replayed in chronological order"
  - id: "A6"
    given: "CLI pause command is executed on running task"
    when: "Task status is checked"
    then: "Task state becomes 'paused' and audit trail contains pause event"
  - id: "A7"
    given: "Real-time metrics are streaming"
    when: "UI dashboard is viewed"
    then: "KPI tiles and charts update without console.log-only behavior"
  - id: "A8"
    given: "User saves a database query"
    when: "Query list is retrieved"
    then: "Saved query persists across application restarts"
  - id: "A9"
    given: "Master key is accessed"
    when: "Logs are inspected"
    then: "Key value never appears in plaintext in any log output"
  - id: "A10"
    given: "System is running"
    when: "Dashboard metrics are viewed"
    then: "CPU and memory metrics show real system values, not simulations"
  - id: "A11"
    given: "Cancel button is clicked in UI"
    when: "Task status is checked after 2 seconds"
    then: "Task state is 'canceled' and worker execution has stopped"
non_functional:
  a11y: ["keyboard-navigation", "screen-reader-labels"]
  perf:
    api_p95_ms: 500
    cancel_propagation_ms: 2000
    websocket_reconnect_ms: 1000
  security:
    - "No plaintext secrets in logs or responses"
    - "API key validation on protected endpoints"
    - "Input validation on all user-provided data"
    - "Audit trail prevents tampering"
  reliability:
    - "Circuit breaker prevents cascade failures"
    - "Retry logic handles transient failures"
    - "Graceful degradation during partial failures"
observability:
  logs:
    - "task.operation.*"
    - "worker.execution.*"
    - "api.request.*"
    - "websocket.connection.*"
  metrics:
    - "api_request_duration"
    - "worker_execution_time"
    - "cancel_propagation_latency"
    - "task_completion_rate"
  traces:
    - "task_execution_flow"
    - "worker_call_chain"
    - "websocket_message_flow"
rollback:
  - "Drop newly created tables in reverse order: waivers, saved_queries, task_events, audit_logs"
  - "Revert API server configuration to previous state"
  - "Restore keystore configuration to previous provider"
  - "Remove new API endpoints and websocket event handlers"
  - "Rollback worker execution to simulation mode if needed"
contracts:
  - type: "openapi"
    path: "docs/api/tasks.yaml"
    operations:
      - "getTaskEvents"
      - "cancelTask"
      - "pauseTask"
      - "resumeTask"
      - "getSavedQueries"
      - "saveQuery"
  - type: "database"
    tables:
      - "audit_logs"
      - "task_events"
      - "saved_queries"
      - "waivers"
  - type: "websocket"
    events:
      - "task_progress"
      - "task_state_change"
      - "metrics_update"