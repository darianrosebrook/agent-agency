id: AGENT-0006
title: "Implement flakiness hardening in evaluation"
risk_tier: 2
mode: feature
change_budget:
  max_files: 8
  max_loc: 450
blast_radius:
  modules: ["self-prompting-agent", "evaluation"]
  data_migration: false
operational_rollback_slo: "2m"
scope:
  in:
    - "iterations/v3/self-prompting-agent/src/evaluation/code_evaluator.rs"
    - "iterations/v3/self-prompting-agent/src/evaluation/flakiness.rs"  # New module
    - "iterations/v3/self-prompting-agent/src/evaluation/mod.rs"  # Add flakiness module
    - "iterations/v3/self-prompting-agent/src/prompting/adaptive.rs"  # Integrate targeted prompts
  out:
    - "iterations/v3/orchestration/"
    - "iterations/v3/database/"
    - "iterations/v3/interfaces/"
    - "iterations/v3/council/"
invariants:
  - "Flaky tests are retried N=2 times with jitter to avoid false positives"
  - "Test failures are bucketed by category (compilation, types, runtime, assertion, snapshot)"
  - "Refinement prompts are targeted based on failure category analysis"
  - "Evaluation results include confidence scores and failure patterns"
  - "Test execution includes timing jitter to detect race conditions"
acceptance:
  - id: "A1"
    given: "Test run fails on first execution"
    when: "N=2 retry policy is applied with jitter"
    then: "test is retried 2 times with randomized delays"
  - id: "A2"
    given: "Compilation error detected in stderr"
    when: "failure bucketing analyzes output"
    then: "failure is categorized as 'compilation' with specific error patterns"
  - id: "A3"
    given: "TypeScript type errors in output"
    when: "failure categorization runs"
    then: "failure bucketed as 'types' with type error patterns extracted"
  - id: "A4"
    given: "Runtime assertion failure"
    when: "failure analysis processes output"
    then: "categorized as 'assertion' with test name and assertion details"
  - id: "A5"
    given: "Snapshot mismatch in test output"
    when: "failure bucketing analyzes stderr"
    then: "categorized as 'snapshot' with snapshot file paths"
  - id: "A6"
    given: "Compilation failure bucket"
    when: "targeted refinement prompt generation"
    then: "prompt includes syntax error fixes and import resolution hints"
  - id: "A7"
    given: "Type error bucket"
    when: "refinement prompt creation"
    then: "prompt includes type annotation suggestions and interface fixes"
contracts:
  - type: "rust-api"
    path: "iterations/v3/self-prompting-agent/src/evaluation/flakiness.rs"
    endpoints:
      - "FlakinessHardener::harden_evaluation()"
      - "FailureBucket::analyze()"
      - "RefinementPromptGenerator::generate_targeted_prompt()"
    schemas:
      - name: "FailureBucket"
        fields: ["category: FailureCategory", "patterns: Vec<String>", "confidence: f64", "examples: Vec<String>"]
      - name: "FlakinessConfig"
        fields: ["retry_count: usize", "jitter_ms: u64", "min_confidence_threshold: f64"]
      - name: "EvaluationResult"
        fields: ["criterion: EvalCriterion", "confidence: f64", "failure_bucket: Option<FailureBucket>", "retry_count: usize"]
non_functional:
  perf:
    retry_overhead_ms: 50
    failure_analysis_ms: 10
    prompt_generation_ms: 25
  security:
    - "no-arbitrary-command-injection"
    - "bounded-retry-limits"
  reliability:
    - "flaky-test-detection"
    - "failure-pattern-recognition"