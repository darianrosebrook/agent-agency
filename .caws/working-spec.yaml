id: AGENT-0003
title: "Add tool-call envelope to prompting strategy"
risk_tier: 2
mode: feature
change_budget:
  max_files: 12
  max_loc: 600
blast_radius:
  modules: ["self-prompting-agent", "orchestration"]
  data_migration: false
operational_rollback_slo: "5m"
scope:
  in:
    - "iterations/v3/self-prompting-agent/src/prompting/"
    - "iterations/v3/self-prompting-agent/src/types.rs"  # Add ActionRequest types
    - "iterations/v3/self-prompting-agent/src/agent.rs"  # Update agent to use tool calls
    - "iterations/v3/self-prompting-agent/src/loop_controller.rs"  # Integrate tool call validation
  out:
    - "iterations/v3/orchestration/"
    - "iterations/v3/database/"
    - "iterations/v3/interfaces/"
    - "iterations/v3/council/"
invariants:
  - "All prompting returns structured JSON tool calls, not free text"
  - "Tool calls are validated against JSON schema before execution"
  - "Invalid tool calls trigger re-prompting with error context"
  - "ActionRequest types are strongly typed and serializable"
  - "Prompting strategy maintains backward compatibility for evaluation"
acceptance:
  - id: "A1"
    given: "Valid ActionRequest JSON from generate_action_request()"
    when: "JSON is parsed and validated"
    then: "ActionRequest struct is created with correct type, changeset, reason, confidence"
  - id: "A2"
    given: "Invalid JSON from generate_action_request()"
    when: "JSON parsing fails"
    then: "Validation error is returned with helpful error message"
  - id: "A3"
    given: "ActionRequest with type='patch' and valid changeset"
    when: "apply_changeset() is called"
    then: "Changes are applied to workspace safely"
  - id: "A4"
    given: "ActionRequest with type='noop' and reason"
    when: "processed by loop controller"
    then: "No changes made, reason logged for learning"
  - id: "A5"
    given: "Tool call violates allow-list or budget"
    when: "validated at tool boundary"
    then: "ActionRequest is rejected, re-prompting triggered"
contracts:
  - type: "rust-api"
    path: "iterations/v3/self-prompting-agent/src/prompting/mod.rs"
    endpoints:
      - "PromptingStrategy::generate_action_request()"
      - "ActionRequest::validate()"
      - "ActionRequest::apply()"
    schemas:
      - name: "ActionRequest"
        fields: ["type: ActionType", "changeset: Option<ChangeSet>", "reason: String", "confidence: f64"]
      - name: "ActionType"
        fields: ["Patch", "Write", "NoOp"]
non_functional:
  perf:
    action_request_generation_ms: 200
    json_validation_ms: 10
  security:
    - "structured-tool-calls"
    - "no-arbitrary-code-execution"
    - "allow-list-enforcement"
  reliability:
    - "json-schema-validation"
    - "error-recovery-reprompting"