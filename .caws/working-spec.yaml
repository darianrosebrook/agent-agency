id: AGENT-0002
title: "Implement first-class File Ops tool with schema and guard"
risk_tier: 2
mode: feature
change_budget:
  max_files: 15
  max_loc: 800
blast_radius:
  modules: ["orchestration", "workspace"]
  data_migration: false
operational_rollback_slo: "5m"
scope:
  in:
    - "iterations/v3/file_ops/"
    - "iterations/v3/orchestration/src/lib.rs"  # Add dependency
    - "iterations/v3/Cargo.toml"  # Add new crate
  out:
    - "iterations/v3/interfaces/"
    - "iterations/v3/council/"
    - "iterations/v3/database/"
    - "iterations/v3/security/"
invariants:
  - "File operations are deterministic and reversible"
  - "Allow-list and budget enforcement happens at tool boundary"
  - "Content hashing prevents undetected file modifications"
  - "ChangeSet operations are atomic within a workspace"
  - "No direct file system access outside workspace abstraction"
acceptance:
  - id: "A1"
    given: "A valid ChangeSet with patches"
    when: "apply() is called on a workspace"
    then: "Files are modified atomically and ChangeSetId is returned"
  - id: "A2"
    given: "A ChangeSet that violates allow-list"
    when: "apply() is called"
    then: "Operation is blocked with clear error message"
  - id: "A3"
    given: "A ChangeSet that exceeds budget limits"
    when: "apply() is called"
    then: "Operation is blocked with budget status"
  - id: "A4"
    given: "A valid ChangeSetId from apply()"
    when: "revert() is called"
    then: "All changes are undone deterministically"
  - id: "A5"
    given: "File contents before apply()"
    when: "apply() then revert() are called"
    then: "File contents are identical to original state"
contracts:
  - type: "rust-api"
    path: "iterations/v3/file_ops/src/lib.rs"
    endpoints:
      - "Workspace::apply()"
      - "Workspace::revert()"
      - "ChangeSet::new()"
    schemas:
      - name: "ChangeSet"
        fields: ["patches: Vec<Patch>"]
      - name: "Patch"
        fields: ["path: String", "hunks: Vec<Hunk>", "expected_prev_sha256: Option<String>"]
      - name: "Hunk"
        fields: ["old_start: u32", "old_lines: u32", "new_start: u32", "new_lines: u32", "lines: String"]
non_functional:
  perf:
    apply_p95_ms: 100
    revert_p95_ms: 50
  security:
    - "no-arbitrary-file-access"
    - "content-hash-validation"
    - "workspace-isolation"
  reliability:
    - "atomic-operations"
    - "deterministic-rollback"